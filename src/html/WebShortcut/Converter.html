<!DOCTYPE html>
<html>
  <head>
    <title>Web Shortcut Converter</title>

	  <link rel="stylesheet" type="text/css" href="webshortcut.css">

	  <link rel="icon" type="image/png" href="favicon16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="favicon32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="favicon192.png" sizes="192x192">
    
    <style>
      fieldset {
        border: 0;
      }
    //    html, body {
    //        min-height:100%;
    //    }
     // #mainarea
//{
  //  display:table;
  //  height:100%;
  ///  width:100%;
//}
//#options
//{
    //display:table-row;
//}
//#filedrag
//{
//    display:table-row;
    //height:100%;  
//}
    </style>
    
    <script src="jquery.js"></script>
    <script src="webshortcut.js"></script>
    <script src="server.js"></script>
  </head>

  <body>
  	<header>
  		<h1>Web Shortcut Tools</h1>
  		<nav>
  		  <h3>
  			<ul>
  			  <li><a href="index.html">Overview</a></li>
  				<li><a href="Launcher.html">Launcher</a></li>
  				<li>Converter</li>
  			</ul>
  			</h3>
  		</nav>
  	</header>
    <div id="mainarea">
    <div id="options">
  <select form="convert">
    <option value="url">Windows (.url)</option>
    <option value="desktop">Linux (.desktop)</option>
    <option value="webloc">Apple (.webloc)</option>
  </select>
            <form id="convert" action="http://abcodeworks.com/cgi/convertshortcut.cgi" method="POST">
  		<fieldset>
            <input id="archive" type="hidden" name="archive">
    		<input id="xmldata" type="hidden" name="xmldata">
  		</fieldset>
  	</form>
        </div>

        <button onclick="submitall()" type="button">Convert All Files</button>

    <!-- Need to fix the drag.  See:
         http://stackoverflow.com/questions/7110353/html5-dragleave-fired-when-hovering-a-child-element
         http://stackoverflow.com/questions/10867506/dragleave-of-parent-element-fires-when-dragging-over-children-elements -->
    <div id="filedrag">
      <table id="shortcuttable" border="1">
        <thead>
          <tr>
            <th>Name</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody id="filetablebody"/>
      </table>
    </div>
    

        </div>

  	<script>
  	    var nextRowID = 1;
  	    var xmlfilelist = document.implementation.createDocument(null, "shortcuts", null);
  	    var xmlfilelistShortcuts = xmlfilelist.documentElement;
  	
  	  // call initialization file
      if (window.File && window.FileList && window.FileReader) {
        Init();
      }
  		
  		function Init() {
  			var filedrag = $("#filedrag")[0];
  
  			// If XMLHttpRequest is available, enable the event listeners and hide the submit button?
  			var xhr = new XMLHttpRequest();
  			if (xhr.upload) {	
  				filedrag.addEventListener("dragover", FileDragHover, false);
  				filedrag.addEventListener("dragleave", FileDragHover, false);
  				filedrag.addEventListener("drop", FileSelectHandler, false);
  				filedrag.style.display = "block";
  			}
     
  		}
  		
  		// file drag hover
  		function FileDragHover(e) {
  			e.stopPropagation();
  			e.preventDefault();
  			e.target.className = (e.type == "dragover" ? "hover" : "");
  		}
  		
  		// file selection
  		function FileSelectHandler(e) {
  		  // cancel event and hover styling
  			FileDragHover(e);
  
        ProcessDraggedShortcutFiles(
          e,
          processResponse,
          function(xhr, ajaxOptions, thrownError) {
            alert('An error occurred submitting the shortcuts to the server: status=' + xhr.status + ' error=' + thrownError);
          }
        );
      }
      
      function htmlEncode(value) {
  		    return $('<div/>').text(value).html();
  		}
  		
  		// See http://stackoverflow.com/questions/3820381/need-a-basename-function-in-javascript
      /*function basename(path) {
         var base = path.split(/[\\/]/).pop();
         if(base.lastIndexOf(".") != -1) {
            base = base.substring(0, base.lastIndexOf("."));
         }
         return base;
      }*/
  
  		function processResponse(response) {
        var tablebody = ""
        
        $(response).find("shortcut").each(function() {
          var shortcut = $(this);
          
          shortcutElement = shortcut[0];


          thisRowID = nextRowID++;

          var name = shortcut.find("name");
          //var filenameStr = filename.text();    
          //var basenameStr = basename(filenameStr);
          //filename.text(basenameStr);
          
          var errormsg = shortcut.find("error");

          if(!errormsg.length) {
              var clonedNode = shortcutElement.cloneNode(true);
              clonedNode.setAttribute("id", thisRowID);
              xmlfilelistShortcuts.appendChild(clonedNode);
          }
          
          var errorflag = 0;
          if(errormsg.length) {
            errorflag = 1;
          }          
            
          tablebody = tablebody + "<tr error=\"" + errorflag + "\" id=\"" + thisRowID + "\">";
  				tablebody = tablebody + "<td>" + htmlEncode(name.text()) + "</td>";
  				if(errormsg.length) {
  					tablebody = tablebody + "<td>" + htmlEncode(errormsg.text()) + "</td>";
  				} else {
  					var urlElement = shortcut.find("url");
  					var url = urlElement.text();
  					tablebody = tablebody + "<td><a href=\"" + htmlEncode(url) + "\">" + htmlEncode(url) + "</a></td>";
  				}
  				<!-- http://www.w3schools.com/jsref/met_table_deleterow.asp -->
  				if(errormsg.length) {
            tablebody = tablebody + "<td/>";
  				} else {
  				  tablebody = tablebody + "<td><a onclick=\"downloadRow(this)\" href=\"#\">Download</a></td>";
  				}
  				tablebody = tablebody + "<td><a onclick=\"deleteRow(this)\" href=\"#\">Remove</a></td>";
  				tablebody = tablebody + "</tr>";
  			});
          
        var m = $("#filetablebody")[0];
  			m.innerHTML = m.innerHTML + tablebody;
  		}
  		
  		function GetShortcutByID(id) {

  		    var element = $(xmlfilelistShortcuts).find("shortcut[id=" + id + "]");
  		    if(element) {
  		        return element[0];
  		    } else {
  		        return undefined;
  		    }
  		}

  		function GetRowID(row) {
  		    return row.getAttribute("id");  
  		}

  		function downloadRow(r) {
        var row = r.parentNode.parentNode;
        //var i = row.rowIndex;
        var rowid = GetRowID(row);  
        
        var xmlfile = document.implementation.createDocument(null, "shortcuts", null);
        var xmlfileShortcuts = xmlfile.documentElement;

        var shortcutElement = GetShortcutByID(rowid);
        var clonedNode = shortcutElement.cloneNode(true);
        xmlfileShortcuts.appendChild(clonedNode);

        var xmlstr;
        if (typeof xmlfile.documentElement !== 'undefined') {
            xmlstr = new XMLSerializer().serializeToString(xmlfile.documentElement);
        } else {
            xmlstr = new XMLSerializer().serializeToString(xmlfile);
        }

        $( "#archive" ).val("none");
        $( "#xmldata" ).val("<?xml version=\"1.0\" encoding=\"UTF-8\"?>" + xmlstr);

        $( "#convert" ).submit();
        //alert(i + " " + rowid);
  		}
  		
  		function deleteRow(r) {
  		    var row = r.parentNode.parentNode;
  		    var i = row.rowIndex;
  		    var rowid = GetRowID(row);
  		    document.getElementById("shortcuttable").deleteRow(i);

  		    var shortcutElement = GetShortcutByID(rowid);
  		    if(shortcutElement) {
  		        xmlfilelistShortcuts.removeChild(shortcutElement);
  		    }
  		}

  		function submitall() {
  		    //event.preventDefault();
  		    //$( "#xmldata" ).val("<?xml version=\"1.0\" encoding=\"UTF-8\"?><note><to>Tove</to></note>");
  		    //var xmlstr = new XMLSerializer().serializeToString(xmlfilelist);
  		    // See http://stackoverflow.com/questions/8474808/how-to-remove-the-xml-declaration-from-opera-when-using-xmlserializer

  		    var xmlstr;
  		    if (typeof xmlfilelist.documentElement !== 'undefined') {
  		        xmlstr = new XMLSerializer().serializeToString(xmlfilelist.documentElement);
  		    } else {
  		        xmlstr = new XMLSerializer().serializeToString(xmlfilelist);
  		    }

  		    $( "#archive" ).val("zip");
  		    $( "#xmldata" ).val("<?xml version=\"1.0\" encoding=\"UTF-8\"?>" + xmlstr);

  		    $( "#convert" ).submit();
  		}
  	</script>
  </body>

</html> 
